# PHP CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-php/ for more details
#
version: 2
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: circleci/php:latest

        environment:
          MYSQL_HOST: 127.0.0.1
          MYSQL_DB: checkin
          MYSQL_USER: root
          MYSQL_ALLOW_EMPTY_PASSWORD: true
      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      - image: mysql:5.7

        environment:
          MYSQL_USER: root
          MYSQL_ALLOW_EMPTY_PASSWORD: true

    working_directory: ~/repo

    steps:
      - checkout
      - run:
          name: Install mysql
          command: |
            sudo apt-get update
            sudo apt-get install -y mysql-client

      - run:
          name: Install PHP
          command: |
            sudo add-apt-repository -y ppa:ondrej/php
            sudo apt-get update
            sudo apt-get install -y php7.2
            sudo apt-get install -y php7.2-pdo php7.2-gd php7.2-mysql


      - run: cp .env.circleci .env

      - run:
          name: Create test Mysql database
          command: mysql -h 127.0.0.1 -u root -e "create database checkin;"

      - run:
          name: Run pre-migrate for testing
          command: mysql -h 127.0.0.1 -u root checkin < ./database/circleci/checkin.sql


      # Download and cache dependencies
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "composer.json" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-

      - run: composer install -n --prefer-dist

      - save_cache:
          paths:
            - ./vendor
          key: v1-dependencies-{{ checksum "composer.json" }}

      # run tests!
      - run:
          name: Run php unit tests
          command: vendor/bin/phpunit --testsuite=Feature --testdox-html report.html

      # notification to stride
      - run:
          name: Notify To Stride When Test Success
          when: on_success
          command: |
            curl -X POST \-H 'Content-Type: application/json' \
            -H 'Authorization: Bearer '"${STRIDE_TOKEN}"'' \
            -d '{"body":{"version":1,"type":"doc","content":[{"type":"applicationCard","attrs": {"text": "test message","collapsible":true,"title":{"text":"Circle CI Report","user":{"icon":{"url":"https://a.slack-edge.com/7f1a0/plugins/circleci/assets/service_512.png","label":"Circle CI"}}},"description":{"text":"'"${CIRCLE_USERNAME}"' built '"${CIRCLE_PROJECT_REPONAME}"' '"${CIRCLE_BRANCH}"'"},"details":[{"lozenge": {"text": "Build Success","appearance": "success"}}],"link":{"url":"'"${CIRCLE_BUILD_URL}"'"}}}]}}' \
            --url "${STRIDE_URL}"
      - run:
          name: Notify To Stride When Test Fail
          when: on_fail
          command: |
            curl -X POST \
            -H 'Content-Type: application/json' \
            -H 'Authorization: Bearer '"${STRIDE_TOKEN}"'' \
            -d '{"body":{"version":1,"type":"doc","content":[{"type":"applicationCard","attrs": {"text": "test message","collapsible":true,"title":{"text":"Circle CI Report","user":{"icon":{"url":"https://a.slack-edge.com/7f1a0/plugins/circleci/assets/service_512.png","label":"Circle CI"}}},"description":{"text":"'"${CIRCLE_USERNAME}"' built '"${CIRCLE_PROJECT_REPONAME}"' '"${CIRCLE_BRANCH}"'"},"details":[{"lozenge": {"text": "Build Failed","appearance": "removed"}}],"link":{"url":"'"${CIRCLE_BUILD_URL}"'"}}}]}}' \
            --url "${STRIDE_URL}"

  prod-deploy:
    machine:
        image: circleci/classic:latest
    steps:
      - checkout
      - run: cp .env.example .env
      - run:
          name: Bundle Install
          command: bundle check || bundle install
      - run:
          name: Deploy if tests pass and branch is Master
          command: bundle exec cap production deploy

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - prod-deploy:
          requires:
            - build
          filters:
            branches:
              only: develop
