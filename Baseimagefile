#Use phusion/baseimage as base image. To make your builds reproducible, make
# sure you lock down to a specific version, not to `latest`!
# See https://github.com/phusion/baseimage-docker/blob/master/Changelog.md for
# a list of version numbers.
FROM phusion/baseimage:master
USER root
MAINTAINER jackyyin
EXPOSE 80 443

# ...put your own build instructions here...
RUN apt-get update \
    && apt-get install -y locales  \
    && locale-gen en_US.UTF-8

ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8

# Use baseimage-docker's init system.
CMD ["/sbin/my_init"]

RUN apt-get update \
    && apt-get install -y --no-install-recommends netcat vim sudo software-properties-common nginx wget\
    && add-apt-repository -y ppa:ondrej/php \
    && apt-get update \
    && apt-get install -y php7.2 \
    && apt-get install -y --no-install-recommends php7.2-fpm php7.2-gd php7.2-mysql php7.2-mbstring php7.2-xml\
    && apt-get remove -y --purge software-properties-common

# composer
WORKDIR /var/www/html
RUN wget https://getcomposer.org/composer.phar -O /usr/local/bin/composer \
    && chmod 755 /usr/local/bin/composer \
    && mkdir -p /var/www/html/vendor

#cronjobs
COPY crontab /etc/cron.d/laravel-cron
RUN touch /var/log/cron.log && chmod -R 600 /etc/crontab /etc/cron.d

# configurations
COPY ./Dockerconfig/nginx.conf /etc/nginx/nginx.conf
COPY ./Dockerconfig/www.conf   /etc/php/7.2/fpm/pool.d/www.conf

### Additional Deamon ###

# Adding additional nginx daemon
RUN mkdir /etc/service/nginx
COPY ./Dockerconfig/service/nginx.sh /etc/service/nginx/run
RUN chmod +x /etc/service/nginx/run

# Adding additional php-fpm daemon
RUN mkdir /etc/service/php-fpm /run/php
COPY ./Dockerconfig/service/php-fpm.sh /etc/service/php-fpm/run
RUN chmod +x /etc/service/php-fpm/run

# Adding additional laravel-worker daemon
RUN mkdir /etc/service/laravel-worker && touch /var/log/laravel-worker.log
COPY ./Dockerconfig/service/laravel-worker.sh /etc/service/laravel-worker/run
RUN chmod +x /etc/service/laravel-worker/run

### Additional Startup Process ###
RUN mkdir -p /etc/my_init.d

# Laravel
COPY ./Dockerconfig/startup/artisan.sh /etc/my_init.d/artisan.sh
RUN chmod +x /etc/my_init.d/artisan.sh

COPY . /var/www/html
# Clean up APT when done.
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
